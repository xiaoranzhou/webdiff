/**
 * Markdown Exporter
 * Exports diff results as Markdown document
 */

const MarkdownExporter = {
    /**
     * Export diff as Markdown
     */
    export() {
        const store = useStore.getState();

        if (!store.diffResult) {
            Utils.showToast('No diff to export', 'warning');
            return;
        }

        try {
            const markdown = this.generateMarkdown(store.diffResult, store.diffStats, store.inputJSON, store.outputJSON);
            const filename = `madmp-diff-${Date.now()}.md`;

            Utils.downloadFile(markdown, filename, 'text/markdown');
            Utils.showToast('Markdown exported successfully', 'success');
        } catch (error) {
            console.error('Markdown export error:', error);
            Utils.showToast('Error exporting Markdown: ' + error.message, 'error');
        }
    },

    /**
     * Generate Markdown content
     * @param {object} changes - Changes object
     * @param {object} stats - Statistics
     * @param {object} inputJSON - Input JSON
     * @param {object} outputJSON - Output JSON
     * @returns {string} - Markdown content
     */
    generateMarkdown(changes, stats, inputJSON, outputJSON) {
        let md = '';

        // Title
        md += '# maDMP Comparison Report\n\n';
        md += `**Generated:** ${new Date().toLocaleString()}\n\n`;

        // Document info
        if (inputJSON && inputJSON.dmp) {
            md += '## Document Information\n\n';
            if (inputJSON.dmp.title) {
                md += `**Title:** ${inputJSON.dmp.title}\n\n`;
            }
            if (inputJSON.dmp.created) {
                md += `**Created:** ${inputJSON.dmp.created}\n\n`;
            }
            if (inputJSON.dmp.modified) {
                md += `**Modified:** ${inputJSON.dmp.modified}\n\n`;
            }
        }

        // Statistics
        md += '## Statistics\n\n';
        md += '| Metric | Value |\n';
        md += '|--------|-------|\n';
        md += `| Total Changes | ${stats.totalChanges} |\n`;
        md += `| Added | ${stats.added} |\n`;
        md += `| Removed | ${stats.removed} |\n`;
        md += `| Modified | ${stats.modified} |\n`;
        md += `| Unchanged | ${stats.unchanged} |\n`;
        md += `| Change Percentage | ${stats.changePercentage}% |\n\n`;

        // Changes Summary
        md += '## Changes Summary\n\n';

        // Added fields
        if (changes.added.length > 0) {
            md += `### âœ… Added Fields (${changes.added.length})\n\n`;
            changes.added.forEach(change => {
                md += `- **${this.escapeMarkdown(change.path)}**\n`;
                md += `  - Value: \`${this.formatValue(change.value)}\`\n`;
            });
            md += '\n';
        }

        // Removed fields
        if (changes.removed.length > 0) {
            md += `### âŒ Removed Fields (${changes.removed.length})\n\n`;
            changes.removed.forEach(change => {
                md += `- **${this.escapeMarkdown(change.path)}**\n`;
                md += `  - Value: \`${this.formatValue(change.value)}\`\n`;
            });
            md += '\n';
        }

        // Modified fields
        if (changes.modified.length > 0) {
            md += `### ðŸ”„ Modified Fields (${changes.modified.length})\n\n`;
            changes.modified.forEach(change => {
                md += `- **${this.escapeMarkdown(change.path)}**\n`;
                md += `  - Old: \`${this.formatValue(change.oldValue)}\`\n`;
                md += `  - New: \`${this.formatValue(change.newValue)}\`\n`;
            });
            md += '\n';
        }

        // Detailed Changes
        md += '## Detailed Changes\n\n';

        if (changes.modified.length > 0) {
            changes.modified.forEach(change => {
                md += `### ${this.escapeMarkdown(change.path)}\n\n`;
                md += '```diff\n';
                md += `- ${this.formatDetailedValue(change.oldValue)}\n`;
                md += `+ ${this.formatDetailedValue(change.newValue)}\n`;
                md += '```\n\n';
            });
        }

        // Footer
        md += '---\n\n';
        md += '*Generated by maDMP Validator & Diff Tool*\n';

        return md;
    },

    /**
     * Format value for display
     * @param {any} value - Value
     * @param {number} maxLength - Max length
     * @returns {string} - Formatted value
     */
    formatValue(value, maxLength = 100) {
        if (value === null || value === undefined) return 'null';

        let str;
        if (typeof value === 'object') {
            str = JSON.stringify(value);
        } else {
            str = String(value);
        }

        if (str.length > maxLength) {
            return str.substring(0, maxLength) + '...';
        }

        return str;
    },

    /**
     * Format detailed value (for code blocks)
     * @param {any} value - Value
     * @returns {string} - Formatted value
     */
    formatDetailedValue(value) {
        if (value === null || value === undefined) return 'null';

        if (typeof value === 'object') {
            return JSON.stringify(value, null, 2);
        }

        return String(value);
    },

    /**
     * Escape Markdown special characters
     * @param {string} text - Text
     * @returns {string} - Escaped text
     */
    escapeMarkdown(text) {
        if (!text) return '';

        const specialChars = ['\\', '`', '*', '_', '{', '}', '[', ']', '(', ')', '#', '+', '-', '.', '!'];

        let escaped = String(text);
        specialChars.forEach(char => {
            escaped = escaped.replace(new RegExp('\\' + char, 'g'), '\\' + char);
        });

        return escaped;
    }
};
